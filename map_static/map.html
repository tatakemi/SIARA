
<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
    html,body,#map{height:100%;margin:0;padding:0}

    /* Estilo para o ícone de Lost (Perdido) - Red X */
    .lost-icon-div {
        background-color: white;
        border: 2px solid red;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        line-height: 26px; /* Alinhamento vertical do texto */
        text-align: center;
        box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    .lost-icon-div i {
        color: red;
        font-size: 18px; 
        font-weight: bold;
    }
    
    /* Estilo para o ícone de Found (Encontrado) - Green Check */
    .found-icon-div {
        background-color: white;
        border: 2px solid green;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        line-height: 26px;
        text-align: center;
        box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    .found-icon-div i {
        color: green;
        font-size: 18px; 
    }

</style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
async function loadReports() {
    try {
        const res = await fetch('/reports.json');
        return await res.json();
    } catch (e) {
        console.error('Falha ao carregar relatórios', e);
        return [];
    }
}

function buildMap(reports) {
    var map = L.map('map').setView([0,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    var group = L.featureGroup();
    
    // Define os ícones personalizados (DivIcon)
    const lostIcon = L.divIcon({
        className: 'lost-icon',
        html: '<div class="lost-icon-div"><i class="fa-solid fa-times"></i></div>', // X vermelho para perdido
        iconSize: [30, 30],
        iconAnchor: [15, 30], 
        popupAnchor: [0, -20]
    });
    
    const foundIcon = L.divIcon({
        className: 'found-icon',
        html: '<div class="found-icon-div"><i class="fa-solid fa-check"></i></div>', // Check verde para encontrado
        iconSize: [30, 30],
        iconAnchor: [15, 30],
        popupAnchor: [0, -20]
    });

    reports.forEach(r=>{
        if (!r.lat || !r.lon) return;

        let icon;
        if (r.type === 'lost') {
            icon = lostIcon;
        } else if (r.type === 'found') {
            icon = foundIcon;
        } else {
            icon = L.icon.Default();
        }
        
        var marker = L.marker([r.lat, r.lon], {icon: icon})
            .bindPopup(`<b>${r.title || ''}</b><br>${r.desc || ''}`);
            
        group.addLayer(marker);
    });

    group.addTo(map);
    if (group.getLayers().length > 0) {
        map.fitBounds(group.getBounds().pad(0.2));
    }

    map.on('click', async function(e) {
        const lat = e.latlng.lat, lon = e.latlng.lng;
        const payload = {lat: lat, lon: lon};
        try {
            await fetch('/pick', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            alert(`Coordenadas selecionadas: ${lat.toFixed(6)}, ${lon.toFixed(6)}\nRetorne ao aplicativo e pressione "Importar coordenadas do mapa" para usá-las.`);
        } catch (err) {
            console.error('Erro ao enviar requisição pick:', err);
            alert('Falha ao enviar as coordenadas. Verifique a conexão do servidor.');
        }
    });
}

loadReports().then(buildMap);
</script>
</body>
</html>
    